[["stock-market-returns.html", "Times series data updates Chapter 1 Stock market returns 1.1 File path 1.2 Monthly returns", " Times series data updates Zhongwei Yao 2023-06-08 Chapter 1 Stock market returns 1.1 File path market_pfmc_m_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/股票市场系列/股票市场交易/综合市场交易数据/TRD_Cnmont1990-12 至 2023-03.xlsx&quot; 1.2 Monthly returns mkt_pfmc_m &lt;- readxl::read_excel(market_pfmc_m_path) %&gt;% setlowercolnames() %&gt;% #&lt; 117: 沪深京A股和创业板和科创板; 53: 沪深A股和创业板和科创板 filter(markettype == 117) %&gt;% mutate(tradingmonth = ymd(str_c(trdmnt, &quot;-01&quot;))) %&gt;% select(tradingmonth, cmretwdos) %&gt;% mutate(cmretwdos = as.double(cmretwdos)) %&gt;% na.omit() 1.2.1 Cumulative MRET: Backward marketret_m_ds &lt;- mkt_pfmc_m for (i in seq(1, 59, 1)){ m &lt;- i + 1 marketret_m_ds &lt;- bind_cols( marketret_m_ds, tibble( &quot;marketret_m_backward_{{m}}m&quot; := slide_period(mkt_pfmc_m$cmretwdos, mkt_pfmc_m$tradingmonth, .period = &quot;month&quot;, .before = i, .complete = T, .f = ~prod(1+.x) - 1) ) ) } 1.2.2 Cumulative MRET: Forward for (i in seq(1, 60, 1)){ marketret_m_ds &lt;- bind_cols( marketret_m_ds, tibble( &quot;marketret_m_forward_{{i}}m&quot; := slide_period(mkt_pfmc_m$cmretwdos, mkt_pfmc_m$tradingmonth, .period = &quot;month&quot;, .before = -1, .after = i, .complete = T, .f = ~prod(1+.x) - 1) ) ) } marketret_m_csmar &lt;- unnest(marketret_m_ds, everything()) %&gt;% rename(marketret_m_backward_1m = cmretwdos) %&gt;% mutate(tradingmonth = ceiling_date(tradingmonth, &quot;m&quot;) -days(1)) #&lt; Write to the local database dbWriteTable(conn_macro, &quot;marketret_m_csmar&quot;, value = marketret_m_csmar, overwrite = TRUE ) "],["market-volatility.html", "Chapter 2 Market volatility 2.1 File path 2.2 Stock market variance", " Chapter 2 Market volatility 2.1 File path market_pfmc_d_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/股票市场系列/股票市场交易/综合市场交易数据/TRD_Cndalym1990-12-19 至 2023-04-20.csv&quot; 2.2 Stock market variance 股票方差是过去252个交易日A股市场加权市场投资组合日收益率平方 market_svar_m_csmar &lt;- data.table::fread(market_pfmc_d_path) %&gt;% tibble() %&gt;% setlowercolnames() %&gt;% filter(markettype == 117) %&gt;% select(tradingdate = trddt, cdretwdos) %&gt;% mutate(tradingdate = ymd(tradingdate), svar = cdretwdos * cdretwdos) %&gt;% na.omit() %&gt;% arrange(tradingdate) %&gt;% mutate(svar = rollsumr(svar, 252, fill = NA)) %&gt;% group_by(year(tradingdate), month(tradingdate)) %&gt;% summarise(tradingdate = last(tradingdate), svar = last(svar)) %&gt;% ungroup() %&gt;% na.omit() %&gt;% mutate(tradingmonth = ceiling_date(tradingdate, &quot;m&quot;) - days(1)) %&gt;% select(tradingmonth, svar) #&lt; Write to the local database dbWriteTable(conn_macro, &quot;market_svar_m_csmar&quot;, value = market_svar_m_csmar, overwrite = TRUE ) "],["market-turnover.html", "Chapter 3 Market turnover 3.1 File path 3.2 Monthly trading volume: All A shares", " Chapter 3 Market turnover 3.1 File path stock_ret_month_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/股票市场系列/股票市场交易/个股回报率/月个股回报率/TRD_Mnth1990-12 至 2023-03.txt&quot; 3.2 Monthly trading volume: All A shares Bottom-up average with all a shares market_turnover_m_csmar &lt;- fread(stock_ret_month_path, colClasses = c(Stkcd = &quot;character&quot;)) %&gt;% setlowercolnames() %&gt;% .[markettype %in% c(1, 4, 16, 32)] %&gt;% .[, tradingmonth := ymd(paste0(trdmnt, &quot;-01&quot;))] %&gt;% .[, .(stkcd, tradingmonth, mclsprc, mnshrtrd, mnvaltrd, msmvosd)] %&gt;% .[, mnshrfloata := msmvosd * 1000 / mclsprc] %&gt;% .[, `:=`(turnover_1 = mnshrtrd / mnshrfloata, turnover_2 = mnvaltrd / (msmvosd * 1000))] %&gt;% na.omit() %&gt;% .[, lapply(.SD, function(x) weighted.mean(x,w = msmvosd)), .SDcols = c(&quot;turnover_1&quot;, &quot;turnover_2&quot;), tradingmonth] %&gt;% setorder(tradingmonth) %&gt;% .[, (c(&quot;turnover_12m_mean_backward_1&quot;, &quot;turnover_12m_mean_backward_2&quot;)) := lapply(.SD, RcppRoll::roll_meanr, n = 12), .SDcols = c(&quot;turnover_1&quot;, &quot;turnover_2&quot;)] %&gt;% .[, (c(&quot;turnover_12m_mean_forward_1&quot;, &quot;turnover_12m_mean_forward_2&quot;)) := lapply(.SD, RcppRoll::roll_meanl, n = 12), .SDcols = c(&quot;turnover_1&quot;, &quot;turnover_2&quot;)] %&gt;% .[, tradingmonth := ceiling_date(tradingmonth, &quot;m&quot;) -days(1)] %&gt;% .[] #&lt; Write to the local database dbWriteTable(conn_macro, &quot;market_turnover_m_csmar&quot;, value = market_turnover_m_csmar, overwrite = TRUE ) "],["inflation.html", "Chapter 4 Inflation 4.1 File path 4.2 Monthly CPI month-to-month", " Chapter 4 Inflation 4.1 File path cpi_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/经济研究系列/宏观经济/价格指数/居民消费价格分类指数月度文件/CME_Mpi12003-02 至 2023-02.xlsx&quot; 4.2 Monthly CPI month-to-month Datasgn [数据标识] - PYM＝上年同月为基期, PYP＝上年同期为基期. Areasgn [地区标识] - 1=全国，2=城镇，3=农村 Epim0101 [居民消费价格指数] - Epim0102 [居民消费价格指数-食品] - Epim0103 [居民消费价格指数-烟酒及用品] - Epim0104 [居民消费价格指数-衣着] - Epim0105 [居民消费价格指数-家庭设备用品及服务] - Epim0106 [居民消费价格指数-医疗保健及个人用品] - Epim0107 [居民消费价格指数-交通和通信] - Epim0108 [居民消费价格指数-娱乐教育文化用品及服务] - Epim0109 [居民消费价格指数-居住] - cpi_m_csmar &lt;- readxl::read_xlsx(cpi_path) %&gt;% slice(3:n()) %&gt;% filter(Areasgn == 1, Datasgn == &quot;PYM&quot;) %&gt;% mutate(tradingmonth = ceiling_date(ymd(paste0(Staper, &quot;-01&quot;)), &quot;m&quot;) - days(1), year = year(tradingmonth), cpi = as.double(Epim0101)) %&gt;% # filter(month(tradingmonth) == 12, !is.na(cpi), year &gt;= 2000) %&gt;% select(tradingmonth, cpi) %&gt;% mutate(inflation = cpi - 100) %&gt;% #&lt; Because inflation information is released only in the following month, we wait for one month before using it in our monthly regression. mutate(inflation = dplyr::lag(inflation, 1)) %&gt;% na.omit() %&gt;% select(-cpi) #&lt; Write to the local database dbWriteTable(conn_macro, &quot;cpi_m_csmar&quot;, value = cpi_m_csmar, overwrite = TRUE ) "],["net-equity-expansion.html", "Chapter 5 Net equity expansion 5.1 File path 5.2 NTIS", " Chapter 5 Net equity expansion 5.1 File path ntis_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/专题研究系列/事件研究/公司事件/IPO事件表/ER_IPO.txt&quot; 5.2 NTIS 过去12个月新股募资金额/当月流通A股市值 ntis_m_csmar &lt;- fread(ntis_path) %&gt;% .[CurrencyCode == &quot;CNY&quot;, .(raisefund = RaiseFund, enddate = fifelse(is.na(EndDate), ListedDate, StartDate))] %&gt;% .[, tradingmonth := floor_date(enddate, &quot;m&quot;)] %&gt;% .[, .(raisefund = sum(raisefund, na.rm = T)), tradingmonth] %&gt;% .[data.table(tradingmonth = seq.Date(ymd(&quot;2000-1-1&quot;), ymd(&quot;2023-1-1&quot;), by = &quot;month&quot;)), on = &quot;tradingmonth&quot;] %&gt;% setorder(tradingmonth) %&gt;% .[, ntis := roll_sumr(raisefund, n = 12, fill = NA, na.rm = T)] %&gt;% .[, .(tradingmonth, ntis)] %&gt;% left_join( readxl::read_excel(market_pfmc_m_path) %&gt;% setlowercolnames() %&gt;% filter(markettype == 117) %&gt;% mutate(tradingmonth = ymd(str_c(trdmnt, &quot;-01&quot;))) %&gt;% select(tradingmonth, cmmvosd) %&gt;% na.omit() ) %&gt;% as.data.table() %&gt;% na.omit() %&gt;% .[, .(tradingmonth = ceiling_date(tradingmonth, &quot;m&quot;) - days(1), ntis = ntis / (cmmvosd * 1000))] #&lt; Write to the local database dbWriteTable(conn_macro, &quot;ntis_m_csmar&quot;, value = ntis_m_csmar, overwrite = TRUE ) "],["government-bond-yields.html", "Chapter 6 Government bond yields 6.1 中债到期收益率曲线 6.2 Short-term yield: 3m 6.3 Long-term yield: 10Yr 6.4 Termspread", " Chapter 6 Government bond yields 中债到期收益率曲线 gb_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/中债/中债国债到期收益率标准期限信息/&quot; 6.1 中债到期收益率曲线 gb_ts &lt;- paste0(gb_path, dir(gb_path, &quot;.xlsx&quot;)) %&gt;% map_dfr( ~readxl::read_xlsx(.x) %&gt;% select(yield = `收益率(%)`, tenure = `标准期限说明`, tradingdate = `日期`) %&gt;% mutate(yield = as.double(yield), tradingdate = ymd(tradingdate), tradingmonth = ceiling_date(tradingdate, &quot;m&quot;) - days(1)) ) %&gt;% group_by(tradingmonth, tenure) %&gt;% summarise_all(last) %&gt;% ungroup() %&gt;% select(-tradingdate) 6.2 Short-term yield: 3m sty_3m_m_cb &lt;- gb_ts %&gt;% filter(tenure == &quot;3m&quot;) %&gt;% select(-tenure) %&gt;% rename(sty = yield) 6.3 Long-term yield: 10Yr lty_10yr_m_cb &lt;- gb_ts %&gt;% filter(tenure == &quot;10y&quot;) %&gt;% select(-tenure) %&gt;% rename(lty = yield) 6.4 Termspread termspread_m_cb &lt;- lty_10yr_m_cb %&gt;% left_join(sty_3m_m_cb) %&gt;% mutate(termspread = lty - sty) %&gt;% select(tradingmonth, termspread) gby_m_cb &lt;- sty_3m_m_cb %&gt;% left_join(lty_10yr_m_cb) %&gt;% left_join(termspread_m_cb) #&lt; Write to the local database dbWriteTable(conn_macro, &quot;gby_m_cb&quot;, value = gby_m_cb, overwrite = TRUE ) "],["market-valuation.html", "Chapter 7 Market valuation 7.1 D/P, E/P, B/M", " Chapter 7 Market valuation mv_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/WIND/指数/指数行情序列/STK_INDEX_VALUATION_update202302.xlsx&quot; 7.1 D/P, E/P, B/M market_valuation_m_wind &lt;- readxl::read_xlsx(mv_path, &quot;WINDA&quot;) %&gt;% mutate(tradingmonth = ymd(ceiling_date(ymd, &quot;month&quot;) - days(1)), ep_winda = 1 / pe, bp_winda = 1 / pb, dp_winda = dp) %&gt;% select(tradingmonth, ep_winda, bp_winda, dp_winda, pe_winda = pe, pb_winda = pb) #&lt; Write to the local database dbWriteTable(conn_macro, &quot;market_valuation_m_wind&quot;, value = market_valuation_m_wind, overwrite = TRUE ) "],["risk-factors.html", "Chapter 8 Risk factors 8.1 File path 8.2 Factor returns", " Chapter 8 Risk factors 8.1 File path ff3_m_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/因子研究系列/Fama-French因子/STK_MKT_THRFACMONTH1990-12 至 2023-03.txt&quot; ff3_d_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/因子研究系列/Fama-French因子/STK_MKT_THRFACDAY1990-12-19 至 2023-04-19.txt&quot; ff5_m_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/因子研究系列/Fama-French因子/STK_MKT_FIVEFACMONTH1994-01 至 2023-03.txt&quot; ff5_d_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/因子研究系列/Fama-French因子/STK_MKT_FIVEFACDAY1994-01-03 至 2023-04-19.txt&quot; ch4_m_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/因子研究系列/动量因子/STK_MKT_CARHARTFOURFACTORS1990-12 至 2023-03.txt&quot; cn4_m_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/因子研究系列/CH_4_fac_update_20211231.csv&quot; cn4_d_path &lt;- &quot;/Volumes/Samsung_T7/Research/Database/CSMAR/因子研究系列/CH_4_fac_daily_update_20211231.csv&quot; 8.2 Factor returns 8.2.1 FF3 ff3_m_csmar &lt;- data.table::fread(ff3_m_path) %&gt;% tibble() %&gt;% setlowercolnames() %&gt;% filter(markettypeid == &quot;P9714&quot;) %&gt;% select(tradingmonth, rp_ff3 = riskpremium1, smb_ff3 = smb1, hml_ff3 = hml1) %&gt;% mutate(tradingmonth = ymd(str_c(tradingmonth, &quot;-01&quot;))) %&gt;% arrange(tradingmonth) 8.2.1.1 Cumulative FF3 returns: Forward for (i in seq(1, 36, 1)){ ff3_m_csmar &lt;- bind_cols( ff3_m_csmar, tibble( &quot;hml_ff3_m_forward_{{i}}m&quot; := slide_period(ff3_m_csmar$hml_ff3, ff3_m_csmar$tradingmonth, .period = &quot;month&quot;, .before = -1, .after = i, .complete = T, .f = ~prod(1+.x) - 1) ) ) } ff3_m_csmar &lt;- unnest(ff3_m_csmar, everything()) %&gt;% mutate(tradingmonth = ceiling_date(tradingmonth, &quot;m&quot;) -days(1)) %&gt;% filter(tradingmonth &gt;= &quot;2000-01-01&quot;) #&lt; Write to the local database dbWriteTable(conn_macro, &quot;ff3_m_csmar&quot;, value = ff3_m_csmar, overwrite = TRUE ) 8.2.2 FFC4 ch4_m_csmar &lt;- data.table::fread(ch4_m_path) %&gt;% tibble() %&gt;% setlowercolnames() %&gt;% filter(markettypeid == &quot;P9714&quot;) %&gt;% select(tradingmonth,rp_ch4=riskpremium1,smb_ch4=smb1, hml_ch4 = hml1, umd_ch4 = umd1) %&gt;% mutate(tradingmonth = ymd(str_c(tradingmonth, &quot;-01&quot;))) 8.2.3 LSY4 来源：https://finance.wharton.upenn.edu/~stambaug/ cn4_m_lsy &lt;- data.table::fread(cn4_m_path, skip = 9) %&gt;% as_tibble() %&gt;% setlowercolnames() %&gt;% mutate(tradingmonth = floor_date(ymd(mnthdt), unit = &quot;m&quot;)) %&gt;% select(-mnthdt) %&gt;% # 注：原因子收益单位为% mutate_at(vars(rf_mon:pmo), ~.x/100) %&gt;% select(tradingmonth, mrf = rf_mon, rp_cn4 = mktrf, vmg_cn4 = vmg, smb_cn4 = smb, pmo_cn4 = pmo) 8.2.4 FF5 ff5_m_csmar &lt;- data.table::fread(ff5_m_path) %&gt;% tibble() %&gt;% setlowercolnames() %&gt;% filter(markettypeid == &quot;P9714&quot;, portfolios == 1) %&gt;% select(tradingmonth,rp_ff5=riskpremium1,smb_ff5=smb1,hml_ff5 = hml1,rmw_ff5 = rmw1,cma_ff5 = cma1) %&gt;% mutate(tradingmonth = ymd(str_c(tradingmonth, &quot;-01&quot;))) %&gt;% arrange(tradingmonth) "],["merge-data.html", "Chapter 9 Merge data", " Chapter 9 Merge data econ_var_m &lt;- marketret_m_csmar %&gt;% left_join(market_svar_m_csmar) %&gt;% left_join(market_turnover_m_csmar) %&gt;% left_join(cpi_m_csmar) %&gt;% left_join(ntis_m_csmar) %&gt;% left_join(sty_3m_m_cb) %&gt;% left_join(lty_10yr_m_cb) %&gt;% left_join(termspread_m_cb) %&gt;% left_join(market_valuation_m_wind) %&gt;% as.data.table() "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
